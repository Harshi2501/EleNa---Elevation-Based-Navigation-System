<!DOCTYPE html>
<html>
<head>
  <title>My Leaflet Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">
  <style>
    :root {
    --primary-color: #1b4d3e;
    --secondary-color: #ffcc33;
    --text-color: #333;
    }

    /* Update body font */
    body {
    font-family: "Lato", sans-serif;
    }

    /* Update sidenav styles */
    .sidenav {
    height: 100%;
    width: 20%;
    position: fixed;
    z-index: 1;
    top: 0;
    left: 0;
    background-color: var(--primary-color);
    overflow-x: hidden;
    padding-top: 0px;
    }

    .sidenav a {
    padding: 10px 16px;
    text-decoration: none;
    font-size: 20px;
    color: #fff;
    display: block;
    }

    .sidenav a:hover {
    background-color: var(--secondary-color);
    color: #333;
    }

    /* Update main styles */
    .main {
        position: relative;
    margin-left: 20%;
    font-size: 16px;
    padding: 10px 10px;
    height: 95vh;
    }

    /* Update map styles */
    .map {
    height: 100%;
    }

    /* Update form styles */
    form {
    margin-left: 20px;
    }

    label {
    color: #fff;
    }

    input[type="text"],
    select,
    input[type="number"] {
    background-color: #fff;
    color: var(--text-color);
    border: none;
    padding: 10px;
    margin-bottom: 10px;
    width: 200px;
    border-radius: 5px;
    }

    /* Update dropdown styles */
    select option {
    background-color: var(--primary-color);
    color: #fff;
    }

    /* Update fancy heading styles */
    .fancy-heading {
    color: #fff;
    font-family: "Lobster", cursive;
    margin-left: 20px;
    font-size: 40px;
    }

    .fancy-subheading {
    color: #fff;
    margin-left: 20px;
    }

    /* Update results styles */
    .results {
    color: #000;
    padding: 5px;
    margin-top: 5px;
    margin-left: 10px;
    margin-right: 10px;
    border: 2px solid var(--secondary-color);
    background-color: #fff;
    text-align: center;
    }

    .results h2 {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .results p {
        margin: 0;
    }

    .leaflet-dashed-line {
        stroke-dasharray: 4, 8;
        stroke: black; /* Customize the dashed line pattern */
    }

    .leaflet-solid-line {
        stroke: red;
    }
</style>
</head>
<body>
    <div class="sidenav">
        <h2 class="fancy-heading">EleNa</h2>
        <h2 class="fancy-subheading">Configurations</h2>
        <form onsubmit="return false;">
            <label for="maxmin">Elevation Preference</label>
            <br>
            <select id="maxmin">
                <option value="max">Maximize Elevation</option>
                <option value="min">Minimize Elevation</option>
            </select>
            <br>
            <label for="percentage">Elevation Max path limit (x%)</label>
            <br>
            <input type="number" id="percentage" name="percentage" min="0" max="100" step="1" value="0">
        </form>
        <hr>
        <div class="results">
            <!-- Result content goes here -->
            <h2 class="results">Legend</h2>
            <p>Shortest Route:</p>
            <p style="color: red;">Red Line</p>
            <br>
            <p>EleNa Route:</p>
            <p style="color: black;">Dashed Black Line</p>
            
        </div>
        <div id="results" class="results">
            <!-- Result content goes here -->
            <h2 class="results">Results</h2>
            <p>Source:</p>
            <p id="source">0.0 0.0</p>
            <br>
            <p>Destination:</p>
            <p id="dest">0.0 0.0</p>
            <br>
            <p>Total Distance (m):</p>
            <p id="totaldist">0 meters</p>
            <br>
            <p>Elevation Gain (m):</p>
            <p id="elevgain">0 meters</p>
            <br>
            <p>Elevation Drop (m):</p>
            <p id="elevdrop">0 meters</p>
        </div>
    </div>

    <div class="main">
        <div id="map" class="map"></div>
    </div>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>

        var mymap = L.map('map').setView([42.37034, -72.505769], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(mymap);

        var popup = L.popup();

        var sourceMarker, destinationMarker;
        var routingControl;
        var routeFromWaypoints;

        function onMapClick(e) {
            if (!sourceMarker) {
                sourceMarker = L.marker(e.latlng).addTo(mymap);
            } else if (!destinationMarker) {
                destinationMarker = L.marker(e.latlng).addTo(mymap);
                calculateRoute();
            } else {
                sourceMarker.removeFrom(mymap);
                destinationMarker.removeFrom(mymap);
                sourceMarker = L.marker(e.latlng).addTo(mymap);
                destinationMarker = null;
                mymap.removeControl(routingControl);
                mymap.removeControl(routeFromWaypoints);
            }
        }

        function calculateRoute() {
            var waypoints = [
                sourceMarker.getLatLng(),
                destinationMarker.getLatLng()
            ];

            console.log(waypoints);

            var options = {
                waypoints: waypoints,
                profile: 'cycling',
                preference: 'shortest',
                routeWhileDragging: true
            };

            // Send the waypoints to the Flask backend
            $.ajax({
                type: 'POST',
                url: '/calculate_route', // Replace with the Flask endpoint URL
                data: JSON.stringify({
                    waypoints: waypoints,
                    option: $('#maxmin').val(),
                    percentage: $('#percentage').val()
                }),
                contentType: 'application/json',
                success: function(response) {
                    console.log(response);
                    // var routeFromBackend = response.route;
                    var routeFromBackend = response.route.map(([first, second]) => [second, first]);
                    // console.log(arr1)

                    document.getElementById("source").innerHTML = [waypoints[0].lat.toFixed(5), waypoints[0].lng.toFixed(5)];
                    document.getElementById("dest").innerHTML = [waypoints[1].lat.toFixed(5), waypoints[1].lng.toFixed(5)];
                    document.getElementById("totaldist").innerHTML = response.curr_dist.toFixed(4);
                    document.getElementById("elevgain").innerHTML = response.elevation_dist.toFixed(4);
                    document.getElementById("elevdrop").innerHTML = response.drop_dist.toFixed(4);

                    routingControl = L.Routing.control({
                        waypoints: waypoints,
                        lineOptions: {
                            styles: [{ className: 'leaflet-dashed-line' }] // Apply the custom style to the route polyline
                        }
                    }).addTo(mymap);

                    routeFromWaypoints = L.Routing.control({
                        waypoints: routeFromBackend,
                        lineOptions: {
                            styles: [{ className: 'leaflet-solid-line' }] // Apply the custom style to the route polyline
                        },
                        createMarker: function() {
                            return null;
                        }
                    }).addTo(mymap);

                    routingControl.hide();
                    routeFromWaypoints.hide();
                }
            });
        }

        mymap.on('click', onMapClick);
        var _geocoderType = L.Control.Geocoder.nominatim();
        var geocoder = L.Control.geocoder({
        geocoder: _geocoderType,
        defaultMarkGeocode: false,
        collapsed: true,
        placeholder: "Search for a location",
        }).on('markgeocode', function(e) {
        mymap.setView(e.geocode.center, 13);
        }).addTo(mymap);

    </script>
</body>
</html>